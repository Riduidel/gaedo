<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Jan 28, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20130128" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Gaedo blueprints backed services - </title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Gaedo blueprints backed services</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2013-01-28</li>
                      
                
                    
                 <li id="projectVersion" class="pull-right">Version: 0.4.19</li>
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">about gaedo-blueprints</li>
                                
      <li>
    
                          <a href="1_gaedo_graph_storage.html" title="An introduction to gaedo graph storage">
          <i class="none"></i>
        An introduction to gaedo graph storage</a>
            </li>
                  
      <li class="active">
    
            <a href="#"><i class="none"></i>Access to generic nodes</a>
          </li>
                  
      <li>
    
                          <a href="3_querying_graph.html" title="Querying a graph">
          <i class="none"></i>
        Querying a graph</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                              
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                                              
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="$sitesearchValue" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <p>Previous document explained with a lot of details how it was possible to store POJOs ina graph using gaedo. This document focuses on the opposite approach : how to start from a pre-existing graph and have it transformed into usable Java objects.</p><div class="section"><h2>An example graph<a name="An_example_graph"></a></h2><p>For that, lets use a classical - and cool - example graph. This cool example will be the nasa.nt (look in <tt>src/test/resources</tt> for a lite version) file listing some of the most prominent spacecrafts launch of history (borrowed from <a class="externalLink" href="https://github.com/mhgrove/Empire">Empire-RDF</a> tests).</p><p>A small extract of that graph can be viewed here.</p><p><img src="images/gaedo_generic_storage_1_pioneer.png" alt="an extract of the rdf graph loaded in neo4j displaying the Pioneer spacecraft" /></p><p>As one may immediatly note, elements of this graph have no associated java type (with relations <tt>java.lang.Object:classes</tt> or <tt>java.lang.Object:type</tt>), neither a class-built id.</p><p>It however has a relationship to a type: <tt>http://www.w3.org/1999/02/22-rdf-syntax-ns#type</tt>. But, unfortunatly, that relationship doesnt targets a java class, but another URI : <tt>http://purl.org/net/schemas/space/Spacecraft</tt>. In a future version, gaedo might be able to associate, staticaly or dynamicaly, that URI to a java class. But for now, unfortunatly, it is unable to.</p><p>As a consequence, I have decided all objects loaded from so-called generic nodes are to be written in properties bags very similar, by their design concept, to <a class="externalLink" href="http://commons.apache.org/beanutils/">commons beanutils</a> <a class="externalLink" href="http://commons.apache.org/beanutils/v1.8.3/apidocs/org/apache/commons/beanutils/DynaBean.html">DynaBeans</a> class : the <tt>PropertyBagMap</tt></p></div><div class="section"><h2>What a nice bag you have !<a name="What_a_nice_bag_you_have_"></a></h2><p>That <tt>PropertyBagMap</tt> is a class that implements two interfaces :</p>
<ol style="list-style-type: decimal">
  <li><tt>PropertyBag</tt> targetted to user code, allows one to get the list of available property and, for each property, list the values associated to that property (more on that later)</li>
  <li><tt>PropertyBagPropertyAccess</tt> is the framework counterpart of <tt>PropertyBag</tt>. it provides more or less the same features, except that it uses <tt>Property</tt> where <tt>PropertyBag</tt> uses <tt>String</tt>. This obviously increases the confidence one can have in code allowing values exchanges between <tt>PropertyBagMap</tt> and its associated vertex in graph, at the code of a less readable code. I wont talk any more about that interface, so please forget it and <b>never use any of its methods</b>.</li>
</ol>
<blockquote><p>But, you may ask, what are those properties Im talking about ?</p>
</blockquote><p>Quite easy. In the upper example graph, the properties the <tt>PropertyBagMap</tt> instance will have are all the edges declared around the vertex I want to load as on object. As an example, the vertex <tt>http://nasa.dataincubator.org/spacecraft/PION2</tt> will have as dynamic properties (accessible only using <tt>PropertyBag</tt> interface)</p>
<ul>
  <li><tt>http://www.w3.org/1999/02/22-rdf-syntax-ns#type</tt></li>
  <li><tt>http://xmlns.com/foaf/0.1/depiction</tt></li>
  <li><tt>http://purl.org/net/schemas/space/internationalDesignator</tt></li>
  <li><tt>http://purl.org/dc/elements/1.1/description</tt></li>
  <li><tt>http://purl.org/net/schemas/space/alternateName</tt></li>
  <li><tt>http://purl.org/net/schemas/space/discipline</tt></li>
  <li><tt>http://purl.org/net/schemas/space/mass</tt></li>
  <li><tt>http://xmlns.com/foaf/0.1/homepage</tt></li>
</ul><p>I talked about the fact that one can list values associated to a property in a <tt>PropertyBag</tt>. Why ?</p><p>Because as available properties are defined by the vertex, and not by any Java class, it is not possible to have any meaningfull ifnormation about the expected cardinality of a property. As an example, what allows us to be sure that the <tt>http://www.w3.org/1999/02/22-rdf-syntax-ns#type</tt> property has one single value ? Nothing. As a consequence, I choosed to consider all properties as multivalued and, as a consequence, to store them as list.</p><p>Obviously, those lists values are typed according to the expressed type of value. As an example, for <tt>http://nasa.dataincubator.org/spacecraft/PION2</tt>, the values of <tt>http://purl.org/net/schemas/space/mass</tt> will be a <tt>List</tt> of one element containing the string 39.2. Why a string ? Because its an untyped literal (the vertex has no <tt>type</tt> property allowing agedo to transform that string into something more meaningfull).</p></div><div class="section"><h2>But how do I fill that bag from my graph ?<a name="But_how_do_I_fill_that_bag_from_my_graph_"></a></h2><p>Loading an object from the graph is no more complicated than with normal Java classes, like the <tt>PropertyBagTest</tt> example well shows.</p>
<ol style="list-style-type: decimal">
  <li>Create a good servcie</li>
  <li>Use all gaedo goodness youre used to</li>
</ol><p>Creating a good service which mapping strategy is graph-driven is quite simple. You may have notice recent (0.3 and 0.4) versions of gaedo clearly jumped the shark regarding constructors. Lets use as an example the <tt>IndexableGraphBackedFinderService</tt> (let me just tell you its in fact the only usable service, as the <tt>SailGraphBackedFinderService</tt>relies upon some messy code that wont stay long live).</p></div><div class="section"><h2>First, construct a service with the right mapping strategy<a name="First_construct_a_service_with_the_right_mapping_strategy"></a></h2><p>Inf act, its not that complicated : use the right constructor and the right parameter value, the right constructor being</p>
<div class="source"><pre class="prettyprint linenums">/**
 * Construct a gaedo servcie allowing reading/writing to an indexable graph
 * @param graph graph we want to write/read to/from
 * @param containedClass class we want to map to that graph
 * @param informerClass informer used to allow easy queries on that class
 * @param factory informer factory
 * @param repository service repository, to load other classes
 * @param provider property provider
 * @param strategy mapping strategy. If bean based, the bean fields will define which edges are read/written. If graph based, that's the edges that define how the object will be loaded.
 */
public IndexableGraphBackedFinderService(IndexableGraph graph, Class&lt;DataType&gt; containedClass, Class&lt;InformerType&gt; informerClass, InformerFactory factory,
          ServiceRepository repository, PropertyProvider provider, StrategyType strategy) {
</pre></div><p>Which would be implemented as </p>
<div class="source"><pre class="prettyprint linenums">new IndexableGraphBackedFinderService(graphTouse, PropertyBagMap.class, PropertyBagInformer.class, factoryTouse, repositoryToUse, providerToUse, StrategyType.graphBased);
</pre></div><p>And the right argument being to use as <tt>StrategyType</tt> the <tt>StrategyType.graphBased</tt> value. Notice that, in this aprticular case, defining a repository is quite irrelevant, as this mapping strategy by considering the graph as the source for type will (fo now) make all loaded vertices instances of <tt>PropertyBagMap</tt>, even if they could be loaded as valid Java objects using <tt>StrategyType.beanBased</tt></p></div><div class="section"><h2>Then use it<a name="Then_use_it"></a></h2><p>As I said earlier, all classical read/write operations are available  obviously with some twists</p></div><div class="section"><h2>All bags are not filled the same<a name="All_bags_are_not_filled_the_same"></a></h2><p>Lets start with findAll, your prefered performance bottleneck. Suppose you call it on your graph. it will obviously load ALL vertices from the graph as (let me repeat) <b>as it uses the graph as property source, it considers all vertices having the <tt>uri</tt> kind as valid <tt>PropertyBagMap</tt> objects</b>. If you find that acceptable  well, good to you, but Im quite sure you wont have that opinion long.</p><p>Indeed, there is an other scary thing to know.</p><p>When using <tt>StrategyType.beanBased</tt> the deepness at which the graph must be explored is totally determined by Java classes. Its a cool thing as, provided your model is not totally connected, it is possible to have an application that is guaranteed to never load all graph vertices.</p><p>This is unfortunatly not the case with <tt>Strategy.graphBased</tt> : when loading a compatible vertex (one with the uri kind), all its linked vertices will also be loaded. This should immediatly raise warnings in your head, as a semantic graph is usually totally connected (and may be highly cyclic). indeed, as all connected vertices will be loaded, if one of these vertices is also elligible to be a <tt>PropertyBagMap</tt>, this vertex will be loaded into an object, which associated vertices will in turn be loaded  Well, you get the point : its really easy to load the whole graph in memory this way.</p><p>using our now classical example, one can see that <tt>http://nasa.dataincubator.org/spacecraft/PION2</tt> is linked to some vertices that will be loaded as <tt>PropertyBagMap</tt> :</p>
<ul>
  <li><tt>http://www.w3.org/1999/02/22-rdf-syntax-ns#type</tt> is <tt>http://purl.org/net/schemas/space/Spacecraft</tt>, which is an URI that will be loaded as a <tt>PropertyBagMap</tt>.</li>
  <li><tt>http://xmlns.com/foaf/0.1/depiction</tt> is <tt>http://nssdc.gsfc.nasa.gov/image/spacecraft/pioneer_able.gif</tt>, which is an URI that will be loaded as a <tt>PropertyBagMap</tt>.</li>
  <li><tt>http://purl.org/net/schemas/space/internationalDesignator</tt> is the literal <tt>PION2</tt></li>
  <li><tt>http://purl.org/dc/elements/1.1/description</tt> is a bloody long literal</li>
  <li><tt>http://purl.org/net/schemas/space/alternateName</tt> is the literal <tt>Able 3</tt></li>
  <li><tt>http://purl.org/net/schemas/space/discipline</tt> is a list of uris : <tt>http://nasa.dataincubator.org/discipline/planetaryscience</tt>, <tt>http://nasa.dataincubator.org/discipline/spacephysics</tt> and <tt>http://nasa.dataincubator.org/discipline/earthscience``, which all will be loaded as a</tt>PropertyBagMap`</li>
  <li><tt>http://purl.org/net/schemas/space/mass</tt> is the literal `39.2</li>
  <li><tt>http://xmlns.com/foaf/0.1/homepage</tt> is the uri <tt>http://nssdc.gsfc.nasa.gov/database/MasterCatalog?sc=PION2</tt> which will be loaded as a <tt>PropertyBagMap</tt>.</li>
</ul><p>As a consequence, to avoid that, a design decision has been made : <b>when using graphBased strategy, only first-level vertices are loaded into objects</b>. Which means that if these associated vertices are loaded as <tt>PropertyBagMap</tt>, they have absolutely no dynamic properties loaded (as one test - <tt>PropertyBagTest#make_sure_only_RootVertex_Is_Totally_Loaded()</tt> - clearly checks), but only their id (which allow later loading them using <tt>findById()</tt>.</p></div><div class="section"><h2>A different kind of id<a name="A_different_kind_of_id"></a></h2><p>So, to get an object one already know, the <tt>findById()</tt> method can indeed be used. Give it the objects uri (yup, id and uris will always be the same), and it will load without any trouble (and the aforementioned limitation regarding deepness of the enttity graph).</p><p>Notie that this uri will aalways be available by calling <tt>PropertyBag#getId()</tt>.</p></div><div class="section"><h2>How to find a particular bag ?<a name="How_to_find_a_particular_bag_"></a></h2><p>Well, if findAll and findById(), you expect find() and dynamic queries to work, right ? <b>wrong</b>  in a sense.</p><p>The find() and <tt>QueryBuilder</tt> idio will work, provided you use the correct property name and informer type. <b>But</b> dyanmic queries wont work (mainly due to the fact that uris arent good method names. Of course I could have thought about an alternatlive mechanism involving annotations and properties synonyms, but it would really had been a nightmare).</p><p>So, its indeed possible to query the graph on a combination of properties. Property name to use is, as you can easily imagine, the property uri.</p><p>As an example, to find Pioneer 2, one could search the graph by <tt>http://purl.org/net/schemas/space/internationalDesignator</tt> having as value <tt>PION2</tt>.</p><p>So, considering service is named <tt>service</tt>, it could be obtained by the following query :</p>
<div class="source"><pre class="prettyprint linenums">service.find().matching(new QueryBuilder() {
    @Override
    public QueryExpression createMatchingExpression(PropertyBagInformer informer) {
       return ((CollectionFieldInformer) informer.get(&quot;`http://purl.org/net/schemas/space/internationalDesignator`&quot;)).containing(&quot;PION2&quot;);
    }
}).getAll();
</pre></div><p>One might ask why is the informer casted to <tt>CollectionFieldInformer</tt>. The answer to that question has some brutal simplicity : as we consider all properties to be multivalued (remember paragraph What a nice bag you have ?), the returned FieldInformer is o adapted type, and as a consequence a <tt>CollectionFieldInformer</tt>.</p><p>And of course obtained values have the classical graph depth limitation : their <tt>PropertyBag</tt> values are loaded, but those values have no loaded properties.</p></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2013
                        <a href="www.dooapp.com">dooApp</a>.
            All Rights Reserved.      
                    
      </div>

        
        
          
    
    
                
    <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="http://www.ohloh.net/p/gaedo/widgets/project_factoids.js"></script>
    </div>
        </div>
    </footer>
  </body>
</html>
