<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Jan 29, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20130129" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Gaedo - </title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Gaedo</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2013-01-29</li>
                      
                
                    
                 <li id="projectVersion" class="pull-right">Version: 0.4.21</li>
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">about gaedo</li>
                                
      <li>
    
                          <a href="1_the_gaedo_case.html" title="the gaedo case">
          <i class="none"></i>
        the gaedo case</a>
            </li>
                  
      <li>
    
                          <a href="2_gaedo_and_collection_storage.html" title="gaedo and collection storage">
          <i class="none"></i>
        gaedo and collection storage</a>
            </li>
                  
      <li>
    
                          <a href="3_method_missing_vs_invokeLater.html" title="method missing vs invokeLater">
          <i class="none"></i>
        method missing vs invokeLater</a>
            </li>
                  
      <li>
    
                          <a href="4_compilable_queries_a_senseless_concept.html" title="compilable queries a senseless concept">
          <i class="none"></i>
        compilable queries a senseless concept</a>
            </li>
                  
      <li>
    
                          <a href="5_dynamic_finders_the_reference.html" title="dynamic finders the reference">
          <i class="none"></i>
        dynamic finders the reference</a>
            </li>
                  
      <li>
    
                          <a href="6_how_to_include_gaedo_in_my_application.html" title="how to include gaedo in my application">
          <i class="none"></i>
        how to include gaedo in my application</a>
            </li>
                  
      <li>
    
                          <a href="7_graphing_queries.html" title="graphing queries">
          <i class="none"></i>
        graphing queries</a>
            </li>
                  
      <li>
    
                          <a href="8_kudos_to_all_of_you.html" title="kudos to all of you">
          <i class="none"></i>
        kudos to all of you</a>
            </li>
                  
      <li>
    
                          <a href="9_gaedo_bug_in_bouncing_queries.html" title="gaedo bug in bouncing queries">
          <i class="none"></i>
        gaedo bug in bouncing queries</a>
            </li>
                  
      <li>
    
                          <a href="10_gaedo_does_graphs.html" title="gaedo does graphs">
          <i class="none"></i>
        gaedo does graphs</a>
            </li>
                              <li class="nav-header">other infos</li>
                                
      <li>
    
                          <a href="easy_release_with_maven.html" title="easy release with maven">
          <i class="none"></i>
        easy release with maven</a>
            </li>
                  
      <li>
    
                          <a href="gaedo_in_the_wild.html" title="gaedo in the wild">
          <i class="none"></i>
        gaedo in the wild</a>
            </li>
                  
      <li class="active">
    
            <a href="#"><i class="none"></i>gaedo supports migrations</a>
          </li>
                  
      <li>
    
                          <a href="guice_integration_is_ready.html" title="guice integration is ready">
          <i class="none"></i>
        guice integration is ready</a>
            </li>
                  
      <li>
    
                          <a href="prevalence_in_gaedo.html" title="prevalence in gaedo">
          <i class="none"></i>
        prevalence in gaedo</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                                                
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                            
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="$sitesearchValue" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <p>Well, the title may be a little overkill (because it only works - for now - using <tt>gaedo-google-datastore</tt>), however Im quite proud of that feature ! </p><p>Anyway, here come the thingy. As christophe suggests in issue 34, there are some cases when applications have long-life data. Particuarly on google app engine, where an application can be endlessly redeployed with updated code. In such a case, mapping of object fields to datastore content may not work. Well, this time could be over. </p><p>Ive indeed decided to add support for object migration to gaedo. The goal is to mimic on live data behaviour possible through frameworks like Rails migration. </p><h1>The concept</h1><p>Conceptually, this is quite simple : each time an object is stored, a special field containing its version is stored alongside. When this object is reloaded from datastore (or any other storing scheme that supports this behaviour), we check that this data version has the same value that the object class. If it is not the case, a migration method is called. </p><p>Simple isnt it ? </p><p>Well, the reality is a little more scaring :-) </p><h1>The implementation</h1><p>To make that work, your class must say it is migrable. Ive chosen this word to make it sure nobody confuse it with versionning mechanism, or auditing as it is also called. </p><p>For that, you simply annotate your class with the @Migrable annotation : </p>
<div class="source"><pre class="prettyprint linenums">@Migrable(migratorClass=MigrableMigrator.class)
public class MigrableObject {
        public static final long serialVersionUID = 1;

        @Id
        public long id;

        public int version = serialVersionUID;

        public String text = &quot;initial&quot;;
}
</pre></div><p>Notice I use a non static field, as the implementation I use to test that feature is <tt>gaedo-google-datastore</tt>, which wont persist static fields. </p><p>Anyway, most of the interesting code is in Migrator class, in the case the MigrableMigrator : </p>
<div class="source"><pre class="prettyprint linenums">public class MigrableMigrator implements Migrator {

        @Override
        public Object getCurrentVersion() {
                return MigrableObject.serialVersionUID;
        }

        @Override
        public String getLiveVersionFieldName() {
                return &quot;version&quot;;
        }

        @Override
        public String getPersistedVersionFieldName() {
                return Migrator.DEFAULT_PERSISTED_VERSION_FIELD_NAME;
        }

        /**
         * Not usual implementation : when given a MigrableObject, it updates the version to an higher one and totally replace text
         */
        @Override
        public &lt;DataContent, ContainedClass&gt; DataContent migrate(
                        FinderCrudService&lt;ContainedClass, ? extends Informer&lt;ContainedClass&gt;&gt; service,
                        DataContent nonMigratedContent, Object sourceVersion,
                        Object targetVersion) {
                if(nonMigratedContent instanceof Entity) {
                        Entity toMigrate = (Entity) nonMigratedContent;
                        toMigrate.setProperty( Utils.getDatastoreFieldName( service.getInformer().get( getLiveVersionFieldName() ).getField() ), MigrableObject.serialVersionUID);
                        return (DataContent) toMigrate;
                }
                return null;
        }
}
</pre></div><p>I wont dive into one-lines methods, as they are direct implementations of Migrator interface, and as a consequence totally defined by this interface. instead, I will go deeper in migrate method. </p><p>As one may note, this method, although present in a class linked to MigrableObject (my model) only works on data serialized from a particular implementation of FinderCrudService. </p><p>This although not optimal, has been considered for now as efficient enough. Later, I may change that behaviour. Anyway, in migrate code, youll only be able to change the content of data objects, this is why we work here on GAE Entity objects. There are, as a consequence, some friction between this method code and Datastore finder service. As a example, data associated to given fields are accesse</p>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2013
                        <a href="www.dooapp.com">dooApp</a>.
            All Rights Reserved.      
                    
      </div>

        
        
          
    
    
                
    <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="http://www.ohloh.net/p/gaedo/widgets/project_factoids.js"></script>
    </div>
        </div>
    </footer>
  </body>
</html>
