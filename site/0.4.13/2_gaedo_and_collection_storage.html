<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Dec 19, 2012
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20121219" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Gaedo - </title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Gaedo</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2012-12-19</li>
                      
                
                    
                 <li id="projectVersion" class="pull-right">Version: 0.4.13</li>
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">about gaedo</li>
                                
      <li>
    
                          <a href="1_the_gaedo_case.html" title="the gaedo case">
          <i class="none"></i>
        the gaedo case</a>
            </li>
                  
      <li class="active">
    
            <a href="#"><i class="none"></i>gaedo and collection storage</a>
          </li>
                  
      <li>
    
                          <a href="3_method_missing_vs_invokeLater.html" title="method missing vs invokeLater">
          <i class="none"></i>
        method missing vs invokeLater</a>
            </li>
                  
      <li>
    
                          <a href="4_compilable_queries_a_senseless_concept.html" title="compilable queries a senseless concept">
          <i class="none"></i>
        compilable queries a senseless concept</a>
            </li>
                  
      <li>
    
                          <a href="5_dynamic_finders_the_reference.html" title="dynamic finders the reference">
          <i class="none"></i>
        dynamic finders the reference</a>
            </li>
                  
      <li>
    
                          <a href="6_how_to_include_gaedo_in_my_application.html" title="how to include gaedo in my application">
          <i class="none"></i>
        how to include gaedo in my application</a>
            </li>
                  
      <li>
    
                          <a href="7_graphing_queries.html" title="graphing queries">
          <i class="none"></i>
        graphing queries</a>
            </li>
                  
      <li>
    
                          <a href="8_kudos_to_all_of_you.html" title="kudos to all of you">
          <i class="none"></i>
        kudos to all of you</a>
            </li>
                  
      <li>
    
                          <a href="9_gaedo_bug_in_bouncing_queries.html" title="gaedo bug in bouncing queries">
          <i class="none"></i>
        gaedo bug in bouncing queries</a>
            </li>
                  
      <li>
    
                          <a href="10_gaedo_does_graphs.html" title="gaedo does graphs">
          <i class="none"></i>
        gaedo does graphs</a>
            </li>
                              <li class="nav-header">other infos</li>
                                
      <li>
    
                          <a href="easy_release_with_maven.html" title="easy release with maven">
          <i class="none"></i>
        easy release with maven</a>
            </li>
                  
      <li>
    
                          <a href="gaedo_in_the_wild.html" title="gaedo in the wild">
          <i class="none"></i>
        gaedo in the wild</a>
            </li>
                  
      <li>
    
                          <a href="gaedo_supports_migrations.html" title="gaedo supports migrations">
          <i class="none"></i>
        gaedo supports migrations</a>
            </li>
                  
      <li>
    
                          <a href="guice_integration_is_ready.html" title="guice integration is ready">
          <i class="none"></i>
        guice integration is ready</a>
            </li>
                  
      <li>
    
                          <a href="prevalence_in_gaedo.html" title="prevalence in gaedo">
          <i class="none"></i>
        prevalence in gaedo</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                                                
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                            
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="$sitesearchValue" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <p>Since its beginning, object oriented programming suffered from <a class="externalLink" href="http://en.wikipedia.org/wiki/Object-relational_impedance_mismatch">impedance mismatch</a> with databases. Google app engine is not an exception. Althgough <a class="externalLink" href="http://code.google.com/intl/fr-FR/appengine/docs/java/javadoc/com/google/appengine/api/datastore/DatastoreService.html">datastore</a> provides the ability to store any kind of data without bullying about missing columns, storing an obejct containing a collection of others obejct in a sane fashion reveals to be a rather complicated task.</p><h1>An example</h1><p>Take as an example the following pair of classes </p>
<div class="source"><pre class="prettyprint linenums">public class User {
    @Id private long id;
    private String login;
    private Collection&lt;Post&gt; posts = new LinkedList&lt;Post&gt;();
}

public class Post {
    @Id private long id;
    private String text;
    private User author;
}
</pre></div><p>There are more than one mapping strategies possible for this collection. </p><h1>Mapping of simple fields</h1><p>But before, let me explain shortly how gaedo maps a Java object to an entity. This is rather simple : the field annotated with <tt>@Id</tt> (which must be a long) is used as a placeholder for objects Key (which kind is associated to object class in service and name is associated to real class), and other fields are associated to entity properties. As an example, the Post class is associated to an entity which looks like</p>
<table class="table table-striped" border="1">
<tr class="a"><th>Key</th><th>Post.text</th><th>Post.author</th></tr>
<tr class="b"><td>Post={id}</td><td>{text}</td><td>User={author.id}</td></tr>
</table><p>As one may already notice, a domain object is always replaced, when used as field from another object or in a collection, by its key. This allow us to escape from the dreaded issue of JPA/JDP, which requires user to put GAE keys in its model when trying to establish relations between objects. </p><p>However, when it comes to collections, the issue is a little more complex. </p><h1>Mapping collection with dynamic properties</h1><p>First solution we used was to create properties for each entries. As an example, if User named toto has written posts with texts A and B we would have the following entities in datastore (for the sake of this example, I removed the user from the Post, to well emphasize the search issue). </p><p>The two posts </p><table class="table table-striped" border="1"> <tr class="a"><th>Key</th><th>Post.text</th></tr> <tr class="b"><td>Post=1</td><td>A</td></tr> <tr class="a"><td>Post=2</td><td>B</td></tr> </table><p>And the User </p><table class="table table-striped" border="1"> <tr class="a"><th>Key</th><th>User.login</th><th>User.posts.count</th><th>User.posts.0</th><th>User.posts.1</th></tr> <tr class="b"><td>User=1</td><td>toto</td><td>2</td><td>Post=1</td><td>Post=2</td></tr> </table><p>This was a simple storage solution, which has one HUGE drawback : how can I find, as an example, the author of Post 1 ? Take a look at <a class="externalLink" href="http://code.google.com/intl/fr-FR/appengine/docs/python/datastore/gqlreference.html">GQL</a>, and youll find that a query requires a property name. So, do we have to look in column named posts.0 ? or in posts.1 ? or in both ? And how will we handle the case of a user who wrote 3 posts ? Clearly, this doesnt scale. As a consequence, we preferred (after having code this alpha-level prototype) to use the sub-entity mechanism. </p><h1>Mapping collections with subentities</h1><p>Indeed, google datastore allows keys to be hierarchical (see <tt>Keyfactory.createKey(Key parent, java.lang.String kind, long id)</tt>). As a consequence, we will create a sub-entity group for each collection of the object, and our example will become (with the Post pair unchanged) </p><table class="table table-striped" border="1"> <tr class="a"><th>Key</th><th>User.login</th></tr> <tr class="b"><td>User=1</td><td>toto</td></tr> <tr class="a"><td>Key</td><td>User.post.value</td></tr> <tr class="b"><td>User=1/posts.0</td><td>Post=1</td></tr> <tr class="a"><td>User=1/posts.1</td><td>Post=2</td></tr> </table><p>Using this strategy, will simply consists in querying upon User.post.value property name. obviously, it increases complexity of data structure, since collections are now stored outside of objects. however, it seems to me more clear, and has the added benefit of allowing easy storage of maps, what previous model didnt allowed. </p>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2012
                        <a href="www.dooapp.com">dooApp</a>.
            All Rights Reserved.      
                    
      </div>

        
        
          
    
    
                
    <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="http://www.ohloh.net/p/gaedo/widgets/project_factoids.js"></script>
    </div>
        </div>
    </footer>
  </body>
</html>
