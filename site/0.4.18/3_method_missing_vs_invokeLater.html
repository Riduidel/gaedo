<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Jan 16, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20130116" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Gaedo - </title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Gaedo</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2013-01-16</li>
                      
                
                    
                 <li id="projectVersion" class="pull-right">Version: 0.4.18</li>
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">about gaedo</li>
                                
      <li>
    
                          <a href="1_the_gaedo_case.html" title="the gaedo case">
          <i class="none"></i>
        the gaedo case</a>
            </li>
                  
      <li>
    
                          <a href="2_gaedo_and_collection_storage.html" title="gaedo and collection storage">
          <i class="none"></i>
        gaedo and collection storage</a>
            </li>
                  
      <li class="active">
    
            <a href="#"><i class="none"></i>method missing vs invokeLater</a>
          </li>
                  
      <li>
    
                          <a href="4_compilable_queries_a_senseless_concept.html" title="compilable queries a senseless concept">
          <i class="none"></i>
        compilable queries a senseless concept</a>
            </li>
                  
      <li>
    
                          <a href="5_dynamic_finders_the_reference.html" title="dynamic finders the reference">
          <i class="none"></i>
        dynamic finders the reference</a>
            </li>
                  
      <li>
    
                          <a href="6_how_to_include_gaedo_in_my_application.html" title="how to include gaedo in my application">
          <i class="none"></i>
        how to include gaedo in my application</a>
            </li>
                  
      <li>
    
                          <a href="7_graphing_queries.html" title="graphing queries">
          <i class="none"></i>
        graphing queries</a>
            </li>
                  
      <li>
    
                          <a href="8_kudos_to_all_of_you.html" title="kudos to all of you">
          <i class="none"></i>
        kudos to all of you</a>
            </li>
                  
      <li>
    
                          <a href="9_gaedo_bug_in_bouncing_queries.html" title="gaedo bug in bouncing queries">
          <i class="none"></i>
        gaedo bug in bouncing queries</a>
            </li>
                  
      <li>
    
                          <a href="10_gaedo_does_graphs.html" title="gaedo does graphs">
          <i class="none"></i>
        gaedo does graphs</a>
            </li>
                              <li class="nav-header">other infos</li>
                                
      <li>
    
                          <a href="easy_release_with_maven.html" title="easy release with maven">
          <i class="none"></i>
        easy release with maven</a>
            </li>
                  
      <li>
    
                          <a href="gaedo_in_the_wild.html" title="gaedo in the wild">
          <i class="none"></i>
        gaedo in the wild</a>
            </li>
                  
      <li>
    
                          <a href="gaedo_supports_migrations.html" title="gaedo supports migrations">
          <i class="none"></i>
        gaedo supports migrations</a>
            </li>
                  
      <li>
    
                          <a href="guice_integration_is_ready.html" title="guice integration is ready">
          <i class="none"></i>
        guice integration is ready</a>
            </li>
                  
      <li>
    
                          <a href="prevalence_in_gaedo.html" title="prevalence in gaedo">
          <i class="none"></i>
        prevalence in gaedo</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                                                
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                            
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-right"></i>
        Project Reports</a>
                  </li>
            </ul>
                
                    
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="$sitesearchValue" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <p>In presentation article of gaedo, we explained (near the end) that gaedo can use methods declared in interfaces without even having to implement these methods. How does it works ? </p><p>Well, this is a typical case of the understimated powers of Java dynamic nature. Contents</p><h1>The inspirators</h1><p>We all saw in Ruby on Rails how <a class="externalLink" href="http://www.thirdbit.net/articles/2007/08/01/10-things-you-should-know-about-method_missing/">method_missing</a> was put to work for generating <a class="externalLink" href="http://weblog.jamisbuck.org/2006/12/1/under-the-hood-activerecord-base-find-part-3"><tt>ActiveRecord</tt></a> finders, back in the days where RoR was really the trendy topic. Now, RoR hass returned to its status of high productivity web framework. And its ideas have been borrowed wwith styles by other web frameworks, like <a class="externalLink" href="http://www.grails.org/GORM+-+Querying">Grails</a>, as an example. </p><p>We were really astounished by this feature, and really wanted to have it, in any possible fashion, in gaedo.  Dynamic proxies 101 </p><p>Well, it turns out it was rather simple  once you know the rules. In the case of gaedo, there are some use case for these dynamic methods :</p>
<ul>
  <li>dynamic finders</li>
  <li>dynamic informers</li>
</ul><p>As you already know by having read the linked articles, in both cases, the rules for method content are rather clear. Whats more, these rules are associated to already existing code : QueryBuilder in dynamic finders case and Informer in dynamic informer case. As a consequence, in both cases, we can write an alogirthm transforming a method name into some executable code. And thats exactly what we do using the magic of <a class="externalLink" href="http://java.sun.com/j2se/1.5.0/docs/api/java/lang/reflect/Proxy.html">Java dynamic proxies</a> ! Let me explain it in a few words. In java, when declaring an interface, one have more than one choice to implement it : </p>
<ul>
  <li>Create a class that directly implements it</li>
  <li>Create a proxy that will transform its calls.</li>
</ul><p>The proxy, contrary to a class that really implements interface methods, simply redirect calls to methods of this interface to an invocation handler. The invocation handler interface is rather simple to implement : </p>
<div class="source"><pre class="prettyprint linenums">public interface InvocationHandler {
    public Object invoke(Object proxy, Method method, Object[] args)
    throws Throwable;
}
</pre></div><p>The invoke method will be called by java internal mechanism each time a method of the interface is called. As one may note, the invoke method is called with the required parameters to do all that we want : </p>
<ul>
  <li>the input proxy object (honestly, I never encnouter a use case where this object was needed. i think its only used when the same invocation handler is used with various proxies, what I do find a bad pattern).</li>
  <li>the <a class="externalLink" href="http://java.sun.com/j2se/1.5.0/docs/api/java/lang/reflect/Method.html">method object</a>, containing all infos about the method being invoked (its name, signature)</li>
  <li>the actual call parameters</li>
</ul><p>Using that, do you think its that hard to transform a method name into a code block for lower level invocation ? </p><h1>Our use cases</h1><p>In these use cases, Ill once again reuse the example classes of compilable queries : User and Post. </p><div class="section"><h2>Dynamic informer<a name="Dynamic_informer"></a></h2><p>As a simple start example, lets see how the dynamic informers are all handled. A dynamic informer class is used to declare a finder service. This finder service can, under some circumstances as an example when a query is performed) be asked for a dynamic informer instance (by the <tt>FinderCrudService#getInformer()</tt>). in such a case, the <tt>FinderCrudService</tt> usually delegates the call to the <tt>ProxyBackedInformerFactory</tt> class, which will create a proxy for the dynamic informer interface like so : </p>
<div class="source"><pre class="prettyprint linenums">// Creation of this class is out of scope
ProxyBackedInformerFactory factory =...;
return proxyInformerFactory.get(UserInformer.class, User.class);
</pre></div><p>Lets dive into its code ! In the most interesting (ie when no such proxy already exists), a new one is created by the create method : </p>
<div class="source"><pre class="prettyprint linenums">return (InformerType) Proxy.newProxyInstance(getClass().getClassLoader(), new Class&lt;?&gt;[] {informerClass}, 
    new InformerClassInvocationHandler(UserInformer.class, User.class, reflectiveInformerFactory.get(containedType)));
</pre></div><p>This is the interesting part. To avoid too complex invocation handler code, we choose to create an invocation handler for each Informer sub-interface. This way, the invoke method of the InformerClassInvocationHandler stay rather simple : </p>
<div class="source"><pre class="prettyprint linenums">public Object invoke(Object proxy, Method invokedMethod,
       Object[] invokedArgs) throws Throwable {
    if(invokedMethod.getDeclaringClass().equals(FieldProjector.class)) {
       // Oh my god ! The dread projector method
       return invokeProjectorMethod(invokedMethod, invokedArgs);
    } else if (invokedMethod.getDeclaringClass().isAssignableFrom(Informer.class)) {
       return invokeInformerMethod(invokedMethod, invokedArgs);
    } else  {
       // Ok, now come the real fun. A method declared here should start by
       // get and be followed by a fieldName with first letter uppercased,
       // for it to be translated.
       String methodName = invokedMethod.getName();
       if (methodName.startsWith(SYNTHETIC_GETTER_PREFIX)) {
         return invokeSyntheticGetter(invokedMethod, methodName);
       } else {
         throw new BadPrefixException(invokedMethod);
       }
    }
}
</pre></div><p>According to method name, and method decalring interface, we will execute various code redirections. The must interesting part being obviously <tt>invokeSyntheticGetter</tt>. This method will simply check that method starts with get and find the field name following that prefix. </p></div><div class="section"><h2>Dynamic finders<a name="Dynamic_finders"></a></h2><p>Well, I wont detail this example. Interested ones should go take a look at <tt>DynamicFinderHandler</tt> and its associated <tt>MethodResolver</tt> class. Suffice to say these two class perform some interesting tricks using string splitting according to various criterias, return type escalation (to allow findAllBy* methods to return collection, list or even TreeSet), and even method parameters types checking. </p><h1>Advantages and drawbacks</h1><p>Since this use of dynamic code has been defined as one of the core features of gaedo, it has been widespread in the code, especially for these finders things. We now consider it a standard tool of gaedo, with its advantages and drawbacks. here they are : </p><p>Anyway, as (G)Rails are famous frameworks specially due to their dynamic finders, it seems us an interesting tool to integrate in our toolkit.</p></div><div class="section"><h2>Advantages<a name="Advantages"></a></h2>
<ul>
  <li>Smaller code</li>
  <li>Ultra-legible find code</li>
  <li>No more need to reconstruct a collection/list/set from results</li>
  <li>Reliance upon existing code</li>
</ul></div><div class="section"><h2>Drawbacks<a name="Drawbacks"></a></h2>
<ul>
  <li>Errors appear at runtime</li>
  <li>Sometimes harder to debug</li>
  <li>Longer development of new find feature (since MethodResolver need to integrate it in its resolution mechanism)</li>
</ul></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2013
                        <a href="www.dooapp.com">dooApp</a>.
            All Rights Reserved.      
                    
      </div>

        
        
          
    
    
                
    <div id="ohloh" class="pull-right">
      <script type="text/javascript" src="http://www.ohloh.net/p/gaedo/widgets/project_factoids.js"></script>
    </div>
        </div>
    </footer>
  </body>
</html>
